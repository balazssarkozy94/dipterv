%----------------------------------------------------------------------------
\chapter{C-RTU család}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
\centering
\includegraphics[width=100mm, keepaspectratio]{figures/2_1_0_CRTU_FAMILY.png}
\caption{C-RTU család \cite{PROLAN_CRTU}}
\end{figure}

A PROLAN Zrt. C-RTU családjával kisméretû, moduláris adatgyûjtõ és vezérlõ rendszereket lehet kialakítani, melyben egy alapkészülék, és egy, vagy több kiegészítõ modul kap helyet. Az alapkészülék, amelyben egy Linux operációs rendszert futtató processzor kártya van, végzi el a különbözõ távoli és közeli kommunikációs feladatokat, valósítja meg a magasabb szintû logikát és feldolgozást, a kiegészítõ modulok konfigurálását és menedzselését. Számos kiegészítõ modul áll rendelkezésre, melyek CAN kommunikációval kapcsolódnak az alapkészülékhez egy moduláris hátlapi buszon keresztül. Ezek a modulok lehetnek például: digitális be- és kimenetek (CR-DIO), feszültség és árammérõk (CR-MM4, CR-VM12, CR-PM12), tápkimaradás áthidaló okos tápegységek (CR-PS), különbözõ kommunikációs interfészt biztosító kiegészítõk (CR-OE) vagy akár elektromos jármû töltés vezérlõk (CR-CC). A legtöbb kiegészítõ modulban lévõ, helyi mikrokontroller a C-RTU alapkészülékkel a hátlapi CAN buszon kommunikál. A kontroller látja el a modul specifikus feladatokat, az alapkészüléknek már csak a magasabb szintû logikát, feldolgozást kell megvalósítania Linux operációs rendszer alól.

Az általam tervezendõ háromfázisú mérõmodul neve a családon belül CR-PM3.

%----------------------------------------------------------------------------
\section{Alapkészülék}
%----------------------------------------------------------------------------

\begin{figure}[!ht]
\centering
\includegraphics[width=100mm, keepaspectratio]{figures/2_1_1_crtu_alap.png}
\caption{C-RTU alapkészülék}
\end{figure}
% TODO CITÁCIÓ NXP, KARO, PROLAN!

Az alapkészülékben egy Ka-Ro electronics GmbH által gyártott ''Computer-On-Module'' található, ez a processzor egy-egy C-RTU alkalmazásnak a lelke. A modulon az NXP i.MX 6UltraLite MCIMX6G2-es processzora van, ez egy alacsony fogyasztású alkalmazás processzor. Emellé a modulon 4GiB eMMC társul, továbbá 256MiB SDRAM, valamint egy komplex tápáramkör, aminek már csak egy bemeneti feszültségre van szüksége a mûködéshez. Helyi kommunikációkhoz, C-RTU rendszeren kívüli modulokkal 2 db RS485 port használható fel. Hardveresen vezeték nélküli opciók közül választhatunk 2G/3G/4G GSM, vagy LTE 450, vagy LoRa kommunikációból, illetve ezek helyett optikai Ethernetet. Mindegyik alapkészülékben van továbbá egy réz alapú Ethernet port is. Az alapkészülék egy 4 modulhely (71.6mm) széles készülékházban kapott helyet.

%----------------------------------------------------------------------------
\section{Kiegészítõ modulok}
%----------------------------------------------------------------------------

A kiegészítõ modulok adják a C-RTU rendszerek flexibilitását, az alapkészülék mellé mindig csak az éppen szükséges ki- és bemenetek kerülnek, ezzel minimalizálva a helyigényt, költségeket.

%----------------------------------------------------------------------------
\subsection{Egységes funkciók}
%----------------------------------------------------------------------------

Majdnem az összes modul STM32F303 alapú, az egyetlen kivétel ezalól a CR-OE modul, mivel azon nincs programozható mikrokontroller.

A modulok elõlapján egységesen egy címbeállító dil switch kap helyet, amely segítségével a C-CAN címét tudjuk beállítani a modulnak, indulás után ez alapján tudja a modul, hogy mely üzenetek vonatkoznak rá. Az összes kiegészítõ készülék, amely valamilyen mikrokontrollert tartalmaz, egy bootloader futtatásával indul, az alapkészülék ezen keresztül tudja akár távolról is frissíteni a firmware-t.

Minden modul elõlapján helyet kapnak a következõ LED-ek, elõírt színnel, funkcióval:

\begin{enumerate}
\item\emph{PWR LED:} Színe zöld, a modulban elõállított egyik tápfeszültségrõl kell járatni.
\item\emph{STAT LED:} Színe zöld, egy processzor GPIO-nak kell vezérlenie.
\item\emph{FAULT LED:} Színe piros, egy processzor GPIO-nak kell vezérlenie.
\item\emph{BUS LED:} Színe citromsárga, egy processzor GPIO-nak kell vezérelnie.
\end{enumerate}

Ezeken felül minden további, modul specifikus kommunikációnak citromsárga LED-et kell mûködtetni, minden digitális bemenetnek narancssárgát, kimenetnek citromsárgát. Az összes LED-nek 3mm-es, víztiszta típusúnak kell lenni.

A CR-PM3 sajnos nem ezek az elõírások alapján készült, mivel a prototípus az ezeket leíró dokumentum elkészülte elõtt már meg lett tervezve és be lett ültetve, így az a korábbi elõírásnak felel meg, ahol azonos funkciójú LED-ek kaptak helyet, de néhányuk más színnel volt elõírva.

A modulok a hátlapon keresztül egy differenciális PPS (Pulse Per Second) jelet kapnak normál mûködés közben, ennek a megszûnésére hardveresen újra kell indítani a modulban található processzort. A modulok elõlapján található még egy reset nyomógomb, amely rövid idejû lenyomásával szintén a processzor újraindítása érhetõ el.

A modulokon programozáshoz Tag-Connect típusú csatlakozók \cite{TAG_CON} vannak elhelyezve, melyek alkatrész beültetése nélkül, egyszerûen NYÁK rajzolat kialakításával használhatók. Ez nem csak költséghatékony, de kisebb területet is foglal el az áramkör maradékától.

A modulok indulás után egy paraméterezõ fázisba kerülnek, ahol az alapkészülék a futásukhoz szükséges adatokat átadja. Ezt követõen a kiegészítõ készülékek életjelet küldenek, valamint a paramétereknek megfelelõen adatokat. A különbözõ adatokat kétféleképpen küldhetik fel az alapkészüléknek:

\begin{enumerate}
\item\emph{Ciklusidõ alapján:} Elõre beállított idõnként a modul elküldi a figyelt változót, annak értékének változásától függetlenül. 
\item\emph{Szignifikancia alapján:} Egy beállított különbséghatárérték átlépése esetén a változó új értékét elküldi az alapkészüléknek, majd onnantól kezdve ezt az új értéket veszi alapnak a változások figyelésénél.
\end{enumerate}

A két változás figyelési módszer egyszerre is alkalmazható, ilyenkor mindig az éppen hamarabb bekövetkezõ kritérium alapján történik a felküldés.

%----------------------------------------------------------------------------
\section{C-CAN protokoll}
%----------------------------------------------------------------------------

A kommunikáció az alapkészülék és modulok között egy CAN alapú, belsõ fejlesztésû C-CAN elnevezésû kommunikációval történik, ez speciális címzéseket és csomag típusokat definiál, egy master-es topológiával.

%----------------------------------------------------------------------------
\section{Mechanikai kialakítás}
%----------------------------------------------------------------------------

A C-RTU család eszközei kalap profilú DIN-sínre szerelhetõk, szemben a Prolan-ban eddig megszokott 19''-os rack-es kivitelû rendszerekkel. A család készülékei a Phoenix Contact BC moduláris készülékházait \cite{PHOENIX_BC} használják, melyek több méretben, kialakításban is elérhetõk.  A nyomtatott áramköri lapok elhelyezése számos módon történhet, az megoldható akár vízszintesen, akár függõlegesen. A sok rögzítési pont következtében kis kiterjedésû modulokat lehet létrehozni az úgynevezett ''szendvics panel'' kialakítással. A C-RTU családban modulonként általában 2 emelet van, illetve ezen felül egy, ami a készülék elõlapját valósítja meg. Az elõlap NYÁK-ból való megvalósítása elõször pazarlónak gondolhatnánk, azonban közepes gyártási darabszámnál, ahol elõlapot marni, vagy szerszámmal gyártatni még túl drága lenne, nem emeli jelentõs mértékben a költségeket, emellett könnyû tervezni, konzisztens és szép eredményt nyújt a sztenderd 0.15/0.15mm-es vezetõ/szigetelõ technológiával. További elõnye a megoldásnak, hogy a felhasználó által nem látható, belsõ oldalra alkatrészek ültethetõek. Ez például a C-RTU alapkészüléknél ki van használva, ott két antennacsatlakozó kerül beültetésre igény szerint, amelyek mögött a réz rajzolaton egy-egy NYÁK antenna került elhelyezésre, így amennyiben a felhasználási területre elég egy kisebb nyereségû antenna, a felhasználók plusz költség nélkül hozzáférnek ezekhez.

TODO 